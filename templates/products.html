<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ê´€ë¦¬ - AI Dropshipping ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    {% include 'nav.html' %}
    
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“¦ ìƒí’ˆ ê´€ë¦¬</h1>
            <p class="text-gray-600">AIê°€ ë°œêµ´í•œ ìˆ˜ìµì„± ë†’ì€ ìƒí’ˆ ëª©ë¡</p>
        </div>
        
        <!-- Products Table -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200" style="table-layout: fixed;">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-64">ìƒí’ˆëª…</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">íŒë§¤ê°€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">ë§ˆì§„ìœ¨</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">ì˜ˆìƒìˆ˜ìµ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">ìƒíƒœ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-64">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for product in products %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ product.id }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-[200px]">
                            <!-- CRITICAL FIX: Force max-width on TD to prevent table overflow -->
                            <div class="truncate overflow-hidden whitespace-nowrap" title="{{ product.title_kr or product.title_cn }}">
                                <a href="/products/{{ product.id }}" class="text-gray-900 hover:text-blue-600 hover:underline font-medium">
                                    {{ product.title_kr or product.title_cn }}
                                </a>
                            </div>
                            <!-- LINK PROTECTION: Truncate long URLs -->
                            <a href="{{ product.original_url }}" target="_blank" 
                               class="text-blue-600 hover:underline text-xs truncate overflow-hidden whitespace-nowrap inline-block max-w-[180px]" 
                               title="{{ product.original_url }}">
                                1688 ì›ë³¸ ë§í¬ â†’
                            </a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ "{:,}".format(product.price_krw) }}ì›
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full {% if product.profit_margin >= 30 %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ "%.1f"|format(product.profit_margin) }}%
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">
                            +{{ "{:,}".format(product.estimated_profit) }}ì›
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if product.status == 'pending' %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                ìŠ¹ì¸ëŒ€ê¸°
                            </span>
                            {% elif product.status == 'approved' %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                ìŠ¹ì¸ë¨
                            </span>
                            {% else %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                {{ product.status }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="/products/{{ product.id }}" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                âœï¸ ìˆ˜ì •
                            </a>
                            {% if product.status == 'pending' %}
                            <button onclick="generateContent({{ product.id }})" class="text-blue-600 hover:text-blue-900 mr-3">
                                ğŸ“ ì½˜í…ì¸  ìƒì„±
                            </button>
                            <button onclick="approveProduct({{ product.id }})" class="text-green-600 hover:text-green-900 mr-3">
                                âœ… ìŠ¹ì¸
                            </button>
                            {% elif product.status == 'approved' %}
                            <button onclick="registerToMarketplace({{ product.id }})" class="text-purple-600 hover:text-purple-900 mr-3">
                                ğŸš€ ë§ˆì¼“ ë“±ë¡
                            </button>
                            {% endif %}
                            <button onclick="deleteProduct({{ product.id }})" class="text-red-600 hover:text-red-900">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not products %}
            <div class="text-center py-12">
                <p class="text-gray-500 text-lg">ì•„ì§ ì†Œì‹±ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
                <p class="text-gray-400 text-sm mt-2">ëŒ€ì‹œë³´ë“œì—ì„œ AI ì†Œì‹±ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        async function generateContent(productId) {
            if (!confirm('ì´ ìƒí’ˆì˜ AI ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/content/generate/${productId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ì½˜í…ì¸  ìƒì„± ì™„ë£Œ!');
                    location.reload();
                } else {
                    alert('ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        async function approveProduct(productId) {
            if (!confirm('ì´ ìƒí’ˆì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/products/${productId}/approve`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ìŠ¹ì¸ ì™„ë£Œ!');
                    location.reload();
                } else {
                    alert('ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        async function registerToMarketplace(productId) {
            const marketplace = prompt('ë“±ë¡í•  ë§ˆì¼“ì„ ì„ íƒí•˜ì„¸ìš” (naver/coupang):');
            if (!marketplace || !['naver', 'coupang'].includes(marketplace)) {
                alert('ì˜¬ë°”ë¥¸ ë§ˆì¼“ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const response = await fetch(`/api/products/${productId}/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({marketplace: marketplace})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ë§ˆì¼“ ë“±ë¡ ì™„ë£Œ!');
                    location.reload();
                } else {
                    alert('ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        async function deleteProduct(productId) {
            if (!confirm('âš ï¸ ì •ë§ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ìƒí’ˆì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    location.reload();
                } else {
                    alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                alert('âŒ ì˜¤ë¥˜: ' + error.message);
            }
        }
    </script>
</body>
</html>
